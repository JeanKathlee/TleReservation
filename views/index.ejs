<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Home - TLE Lab Reservation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <% if (!user) { %>
      <!-- Sign-in form for guests -->
      <%- include('navbar') %>
      <main class="container py-5">
        <div class="row justify-content-center">
          <div class="col-md-6">
            <div class="card shadow-sm">
              <div class="card-body">
                <h3 class="card-title">Sign in to continue</h3>
                <form method="post" action="/login">
                  <div class="mb-2">
                    <label class="form-label">Username</label>
                    <input name="username" class="form-control" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" name="password" class="form-control" />
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-primary">Login</button>
                    <a href="/signup" class="btn btn-link">Create account</a>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </main>
    <% } else if (user.role === 'admin') { %>
      <!-- Admin view uses shared navbar (includes Switch/Logout) -->
      <%- include('navbar') %>

      <main class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2>Manage Reservations</h2>
        </div>

        <!-- Tabs for Lab and Equipment Reservations -->
        <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="lab-admin-tab" data-bs-toggle="tab" data-bs-target="#labReservations" type="button" role="tab">
              <i class="bi bi-building me-2"></i>Laboratory Reservations
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="equipment-admin-tab" data-bs-toggle="tab" data-bs-target="#equipmentReservations" type="button" role="tab">
              <i class="bi bi-tools me-2"></i>Equipment Reservations
            </button>
          </li>
        </ul>

        <div class="tab-content">
          <!-- Lab Reservations Tab -->
          <div class="tab-pane fade show active" id="labReservations" role="tabpanel">
            <div class="card shadow-sm">
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-striped mb-0">
                    <thead class="table-light">
                      <tr>
                        <th style="width: 5%;">ID</th>
                        <th style="width: 15%;">Venue</th>
                        <th style="width: 10%;">Date</th>
                        <th style="width: 12%;">Time</th>
                        <th style="width: 12%;">Person</th>
                        <th style="width: 12%;">Equipment</th>
                        <th style="width: 15%;">Purpose</th>
                        <th style="width: 8%;">Status</th>
                        <th style="width: 11%;">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% 
                      const labReservations = reservations.filter(r => r.venue !== 'Equipment Reservation');
                      if (labReservations.length > 0) { %>
                        <% labReservations.forEach(r => { %>
                          <tr>
                            <td><a href="/reservation/<%= r.id %>"><%= r.id %></a></td>
                            <td><%= r.venue %></td>
                            <td><%= r.date %></td>
                            <td class="text-nowrap"><%= r.time_from %> - <%= r.time_to %></td>
                            <td><%= r.person_name %></td>
                            <td><%= r.equipment || '-' %></td>
                            <td><%= r.purpose %></td>
                            <td><span class="badge bg-<%= r.status==='approved' ? 'success' : r.status==='declined' ? 'danger' : 'secondary' %>"><%= r.status %></span></td>
                            <td class="text-nowrap">
                              <form method="post" action="/admin/decision/<%= r.id %>" class="d-inline me-1" onsubmit="return confirm('Are you sure you want to APPROVE this reservation?');">
                                <button name="decision" value="approved" class="btn btn-sm btn-success" title="Approve">
                                  <i class="bi bi-check-lg"></i>
                                </button>
                              </form>
                              <form method="post" action="/admin/decision/<%= r.id %>" class="d-inline me-1" onsubmit="return confirm('Are you sure you want to DECLINE this reservation?');">
                                <button name="decision" value="declined" class="btn btn-sm btn-danger" title="Decline">
                                  <i class="bi bi-x-lg"></i>
                                </button>
                              </form>
                              <form method="post" action="/admin/delete/<%= r.id %>" class="d-inline" onsubmit="return confirm('Are you sure you want to DELETE reservation #<%= r.id %>? This action cannot be undone.');">
                                <button class="btn btn-sm btn-outline-danger" title="Delete">
                                  <i class="bi bi-trash"></i>
                                </button>
                              </form>
                            </td>
                          </tr>
                        <% }) %>
                      <% } else { %>
                        <tr>
                          <td colspan="9" class="text-center text-muted py-4">No lab reservations yet</td>
                        </tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Equipment Reservations Tab -->
          <div class="tab-pane fade" id="equipmentReservations" role="tabpanel">
            <div class="card shadow-sm">
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-striped mb-0">
                    <thead class="table-light">
                      <tr>
                        <th style="width: 5%;">ID</th>
                        <th style="width: 20%;">Equipment</th>
                        <th style="width: 10%;">Date</th>
                        <th style="width: 12%;">Time</th>
                        <th style="width: 12%;">Person</th>
                        <th style="width: 20%;">Purpose</th>
                        <th style="width: 8%;">Status</th>
                        <th style="width: 13%;">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% 
                      const equipmentReservations = reservations.filter(r => r.venue === 'Equipment Reservation');
                      if (equipmentReservations.length > 0) { %>
                        <% equipmentReservations.forEach(r => { %>
                          <tr>
                            <td><a href="/reservation/<%= r.id %>"><%= r.id %></a></td>
                            <td><%= r.equipment || '-' %></td>
                            <td><%= r.date %></td>
                            <td class="text-nowrap"><%= r.time_from %> - <%= r.time_to %></td>
                            <td><%= r.person_name %></td>
                            <td><%= r.purpose %></td>
                            <td><span class="badge bg-<%= r.status==='approved' ? 'success' : r.status==='declined' ? 'danger' : 'secondary' %>"><%= r.status %></span></td>
                            <td class="text-nowrap">
                              <form method="post" action="/admin/decision/<%= r.id %>" class="d-inline me-1" onsubmit="return confirm('Are you sure you want to APPROVE this reservation?');">
                                <button name="decision" value="approved" class="btn btn-sm btn-success" title="Approve">
                                  <i class="bi bi-check-lg"></i>
                                </button>
                              </form>
                              <form method="post" action="/admin/decision/<%= r.id %>" class="d-inline me-1" onsubmit="return confirm('Are you sure you want to DECLINE this reservation?');">
                                <button name="decision" value="declined" class="btn btn-sm btn-danger" title="Decline">
                                  <i class="bi bi-x-lg"></i>
                                </button>
                              </form>
                              <form method="post" action="/admin/delete/<%= r.id %>" class="d-inline" onsubmit="return confirm('Are you sure you want to DELETE reservation #<%= r.id %>? This action cannot be undone.');">
                                <button class="btn btn-sm btn-outline-danger" title="Delete">
                                  <i class="bi bi-trash"></i>
                                </button>
                              </form>
                            </td>
                          </tr>
                        <% }) %>
                      <% } else { %>
                        <tr>
                          <td colspan="8" class="text-center text-muted py-4">No equipment reservations yet</td>
                        </tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    <% } else { %>
      <!-- Regular user view with sidebar -->
      <%- include('navbar') %>
      
      <div class="d-flex">
        <%- include('sidebar') %>
        
        <main class="flex-grow-1 p-4">
          <h2 class="mb-4">Make a Reservation</h2>
          
          <!-- Tab navigation for reserve forms -->
          <ul class="nav nav-tabs mb-3" id="reserveTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="lab-tab" data-bs-toggle="tab" data-bs-target="#labForm" type="button" role="tab">
                <i class="bi bi-building me-2"></i>Reserve Laboratory
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="equipment-tab" data-bs-toggle="tab" data-bs-target="#equipmentForm" type="button" role="tab">
                <i class="bi bi-tools me-2"></i>Reserve Equipment
              </button>
            </li>
          </ul>

          <div class="tab-content">
            <!-- Lab Reservation Form -->
            <div class="tab-pane fade show active" id="labForm" role="tabpanel">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h4 class="card-title">Reserve a Laboratory</h4>
                  <p class="text-muted">Fill in the details below to request a laboratory reservation.</p>
                  <form action="/reserve" method="post" class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Venue</label>
                      <select name="venue" class="form-select" required>
                        <option>Home Economics Lab</option>
                        <option>Sewing Lab</option>
                        <option>Accounting Lab</option>
                        <option>BPFM Lab</option>
                        <option>Housekeeping Lab</option>
                        <option>Comp Lab 1</option>
                        <option>Comp Lab 2</option>
                        <option>Drafting Lab</option>
                        <option>EMS/Caregiving</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Date</label>
                      <input type="date" name="date" class="form-control" required>
                    </div>
                    <div class="col-md-3"></div>
                    <div class="col-md-3">
                      <label class="form-label">Time From</label>
                      <input type="time" name="time_from" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Time To</label>
                      <input type="time" name="time_to" class="form-control" required>
                    </div>
                    <div class="col-12">
                      <label class="form-label">Purpose of Activity</label>
                      <input type="text" name="purpose" class="form-control">
                    </div>
                    <div class="col-12">
                      <label class="form-label">Tools, Equipment / Facilities to be used</label>
                      <input type="text" name="equipment" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Person making the reservation</label>
                      <input type="text" name="person_name" class="form-control" required>
                    </div>
                    <div class="col-12 mt-3">
                      <button type="submit" class="btn btn-success">Submit Reservation</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Equipment Reservation Form -->
            <div class="tab-pane fade" id="equipmentForm" role="tabpanel">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h4 class="card-title">Reserve Equipment</h4>
                  <p class="text-muted">Fill in the details below to reserve equipment. You can add multiple items.</p>
                  <form action="/reserve-equipment" method="post" class="row g-3" id="equipmentReservationForm">
                    <div class="col-md-3">
                      <label class="form-label">Date</label>
                      <input type="date" name="date" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Time From</label>
                      <input type="time" name="time_from" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Time To</label>
                      <input type="time" name="time_to" class="form-control" required>
                    </div>
                    <div class="col-md-3"></div>
                    
                    <div class="col-12">
                      <label class="form-label">Equipment Items</label>
                      <div id="equipmentItems">
                        <div class="row g-2 mb-2 equipment-row">
                          <div class="col-md-7">
                            <input type="text" name="equipment_name[]" class="form-control" placeholder="Equipment name" required>
                          </div>
                          <div class="col-md-3">
                            <input type="number" name="equipment_qty[]" class="form-control" placeholder="Quantity" min="1" value="1" required>
                          </div>
                          <div class="col-md-2">
                            <button type="button" class="btn btn-outline-danger w-100 remove-equipment" disabled>Remove</button>
                          </div>
                        </div>
                      </div>
                      <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addEquipment">+ Add Another Item</button>
                    </div>
                    
                    <div class="col-12">
                      <label class="form-label">Purpose / Notes</label>
                      <input type="text" name="purpose" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Person making the reservation</label>
                      <input type="text" name="person_name" class="form-control" required>
                    </div>
                    <div class="col-12 mt-3">
                      <button type="submit" class="btn btn-success">Submit Equipment Reservation</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    <% } %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Dynamic equipment rows
      document.getElementById('addEquipment')?.addEventListener('click', function() {
        const container = document.getElementById('equipmentItems');
        const newRow = document.createElement('div');
        newRow.className = 'row g-2 mb-2 equipment-row';
        newRow.innerHTML = `
          <div class="col-md-7">
            <input type="text" name="equipment_name[]" class="form-control" placeholder="Equipment name" required>
          </div>
          <div class="col-md-3">
            <input type="number" name="equipment_qty[]" class="form-control" placeholder="Quantity" min="1" value="1" required>
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-outline-danger w-100 remove-equipment">Remove</button>
          </div>
        `;
        container.appendChild(newRow);
        updateRemoveButtons();
      });
      
      document.getElementById('equipmentItems')?.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-equipment')) {
          e.target.closest('.equipment-row').remove();
          updateRemoveButtons();
        }
      });
      
      function updateRemoveButtons() {
        const rows = document.querySelectorAll('.equipment-row');
        rows.forEach((row, index) => {
          const btn = row.querySelector('.remove-equipment');
          if (rows.length === 1) {
            btn.disabled = true;
          } else {
            btn.disabled = false;
          }
        });
      }
    </script>
  </body>
</html>
